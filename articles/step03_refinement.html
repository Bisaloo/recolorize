<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Step 3: Refinement • recolorize</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Step 3: Refinement">
<meta property="og:description" content="recolorize">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">recolorize</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/step00_prep.html">Step 0: Image acquisition and preparation</a>
    </li>
    <li>
      <a href="../articles/step01_loading.html">Step 1: Loading &amp; processing images</a>
    </li>
    <li>
      <a href="../articles/step02_initial_cluster.html">Step 2: Initial clustering</a>
    </li>
    <li>
      <a href="../articles/step03_refinement.html">Step 3: Refinement</a>
    </li>
    <li>
      <a href="../articles/step04_manual_tweak.html">Step 4: Tweaks &amp; edits</a>
    </li>
    <li>
      <a href="../articles/step05_visualization_export.html">Step 5: Exporting &amp; visualizing output</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="step03_refinement_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Step 3: Refinement</h1>
            
      
      
      <div class="hidden name"><code>step03_refinement.Rmd</code></div>

    </div>

    
    
<blockquote>
<p>Using simple rules to improve the initial results.</p>
</blockquote>
<ul>
<li>
<a href="Introduction.html">Introduction</a><br>
</li>
<li>
<a href="step00_prep.html">Step 0: Image acquisition and preparation</a><br>
</li>
<li>
<a href="step01_loading.html">Step 1: Loading &amp; processing images</a><br>
</li>
<li>
<a href="step02_initial_cluster.html">Step 2: Initial clustering</a><br>
</li>
<li>Step 3: Refinement</li>
<li>
<a href="step04_manual_tweak.html">Step 4: Tweaks &amp; edits</a><br>
</li>
<li><a href="step05_visualization_export.html">Step 5: Visualizing &amp; exporting output</a></li>
</ul>
<blockquote>
<p>You can also tour the functions in the <a href="https://hiweller.rbind.io/post/function-gallery-for-recolorize/" class="external-link">function gallery</a>.</p>
</blockquote>
<p>Once we’ve reduced an image down to a tractable number of colors, we can define simple procedures for how to combine them based on similarity. <code>recolorize</code> (currently) comes with two of these: <code>recluster</code>, which merges colors by perceived similarity, and <code>thresholdRecolor</code>, which drops minor colors. Both are simple, but surprisingly effective. They’re also built on top of some really simple functions we’ll see in a bit, so if you need to, you can build out a similar procedure tailored to your dataset—for example, combining layers based only on their brightness values, or only combining green layers.</p>
<div class="section level3">
<h3 id="recluster-and-recolorize2">
<code>recluster()</code> and <code>recolorize2()</code><a class="anchor" aria-label="anchor" href="#recluster-and-recolorize2"></a>
</h3>
<p>This is the one I use the most often, and its implementation is really simple. This function calculates the Euclidean distances between all the color centers in a recolorize object, clusters them hierarchically using <code>hclust</code>, then uses a user-specified cutoff to combine the most similar colors. As with <code>recolorize</code>, you can choose your color space, and that will make a big difference. Let’s see this in action:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hiweller.github.io/recolorize/">recolorize</a></span><span class="op">)</span>
<span class="va">corbetti</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/corbetti.png"</span>, package <span class="op">=</span> <span class="st">"recolorize"</span><span class="op">)</span>
<span class="va">init_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recolorize.html">recolorize</a></span><span class="op">(</span><span class="va">corbetti</span>, plotting <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Using 2^3 = 8 total bins</span>
<span class="va">recluster_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recluster.html">recluster</a></span><span class="op">(</span><span class="va">init_fit</span>, 
                               cutoff <span class="op">=</span> <span class="fl">45</span><span class="op">)</span></code></pre></div>
<p><img src="step03_refinement_files/figure-html/unnamed-chunk-3-1.png" width="384" style="display: block; margin: auto;"><img src="step03_refinement_files/figure-html/unnamed-chunk-3-2.png" width="384" style="display: block; margin: auto;"></p>
<p>Notice the color dendrogram: it lumped together clusters 4 &amp; 7, clusters 3 &amp; 5, and clusters 6 &amp; 8, because their distance was less than 45. This is in CIE Lab space; if we use RGB space, the range of distances is 0-1:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">recluster_rgb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recluster.html">recluster</a></span><span class="op">(</span><span class="va">init_fit</span>, color_space <span class="op">=</span> <span class="st">"sRGB"</span>,
                           cutoff <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></code></pre></div>
<p><img src="step03_refinement_files/figure-html/unnamed-chunk-4-1.png" width="384" style="display: block; margin: auto;"><img src="step03_refinement_files/figure-html/unnamed-chunk-4-2.png" width="384" style="display: block; margin: auto;"></p>
<p>In this case, we get the same results, but this is always worth playing around with. Despite its simplicity, this function is highly effective at producing intuitive results. This is partly because, in only using color similarity to combine clusters, it does not penalize smaller color clusters that can still retain important details. Because of its utility (and speed), I included a wrapper function, <code>recolorize2</code>, to run <code>recolorize</code> and <code>recluster</code> sequentially in a single step:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># let's use a different image:</span>
<span class="va">img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/chongi.png"</span>, package <span class="op">=</span> <span class="st">"recolorize"</span><span class="op">)</span>

<span class="co"># this is identical to running:</span>
<span class="co"># fit1 &lt;- recolorize(img, bins = 3)</span>
<span class="co"># fit2 &lt;- recluster(fit1, cutoff = 50)</span>
<span class="va">chongi_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recolorize2.html">recolorize2</a></span><span class="op">(</span><span class="va">img</span>, bins <span class="op">=</span> <span class="fl">3</span>, cutoff <span class="op">=</span> <span class="fl">45</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Using 3^3 = 27 total bins</span></code></pre></div>
<p><img src="step03_refinement_files/figure-html/unnamed-chunk-5-1.png" width="480" style="display: block; margin: auto;"><img src="step03_refinement_files/figure-html/unnamed-chunk-5-2.png" width="480" style="display: block; margin: auto;"></p>
<p>There’s also a lot of room for modification here: this is a pretty unsophisticated rule for combining color clusters (ignoring, for example, cluster size, proximity, geometry, and boundary strength), but it’s pretty simple to write better rules if you can think of them, because the functions that are called to implement this are also exported by the package.</p>
</div>
<div class="section level3">
<h3 id="thresholdrecolor">
<code>thresholdRecolor()</code><a class="anchor" aria-label="anchor" href="#thresholdrecolor"></a>
</h3>
<p>An even simpler rule: drop the smallest color clusters whose cumulative sum (as a proportion of total pixels assigned) is lower than some threshold, like 5% of the image. I thought this would be too simple to be useful, but every once in a while it’s just the thing, especially if you always end up with weird spurious details.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">chongi_threshold</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/thresholdRecolor.html">thresholdRecolor</a></span><span class="op">(</span><span class="va">chongi_fit</span>, pct <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></code></pre></div>
<p><img src="step03_refinement_files/figure-html/unnamed-chunk-6-1.png" width="480" style="display: block; margin: auto;"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Hannah Weller.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
